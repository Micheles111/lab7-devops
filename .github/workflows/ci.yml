name: Debug Port Issue

on:
  push:
    branches: [ main ]

jobs:
  debug-calc:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build and run calc service
      run: |
        cd microase7/src/calc
        docker build -t calc .
        docker run -d -p 5001:5000 --name calc_test calc
        sleep 15

    - name: Debug container and network
      run: |
        echo "=== CONTAINER STATUS ==="
        docker ps -a
        echo "=== CONTAINER LOGS ==="
        docker logs calc_test
        echo "=== NETWORK CHECK ==="
        docker exec calc_test netstat -tulpn || echo "Cannot exec into container"
        echo "=== PORT CHECK ==="
        curl -v http://localhost:5001/ || echo "Curl failed"
        echo "=== TEST FILE CONTENT ==="
        head -20 microase7/tests/calc_ut.postman_collection.json
        echo "=== MODIFIED TEST FILE ==="
        cd microase7/tests
        cp calc_ut.postman_collection.json calc_ut_temp.json
        sed -i 's/localhost:5000/localhost:5001/g' calc_ut_temp.json
        grep "localhost:500" calc_ut_temp.json | head -5

    - name: Test with direct curl
      run: |
        echo "=== DIRECT CURL TEST ==="
        curl http://localhost:5001/add?a=5&b=3 || echo "Direct test failed"

    - name: Cleanup
      if: always()
      run: |
        docker stop calc_test || true
        docker rm calc_test || true
